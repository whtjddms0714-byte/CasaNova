---
layout: default
title: "Property Recommendations (Info 3)"
permalink: /properties.html # Must match JS redirect logic
---

<h1>Recommended Properties</h1>

<p>
  Based on your profile and the selected loan limit, this page requests
  recommended properties from the Django API
  (<code>/api/recommend-properties/</code>).
</p>

<div
  class="header-action"
  style="
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  "
>
  <a
    href="/info-1/"
    style="color: var(--casa-nova-primary); text-decoration: none"
  >
    ‚Üê Re-enter financial information
  </a>
  <a
    href="/loans.html"
    style="color: var(--casa-nova-primary); text-decoration: none"
  >
    View loan recommendations again ‚Üí
  </a>
</div>

<div
  id="status-box"
  style="
    margin-top: 1rem;
    font-weight: bold;
    font-size: 1.1em;
    padding: 10px;
    border: 1px solid var(--casa-nova-secondary);
    background-color: #f9f9ff;
    border-radius: 8px;
  "
>
  Preparing request...
</div>

<div
  id="properties-card-container"
  class="property-card-grid"
  style="display: none"
></div>

<script>
  const API_BASE = "http://127.0.0.1:8000/api";
  const statusBox = document.getElementById("status-box");

  // Legacy table references (kept for compatibility, but hidden later)
  const table = document.getElementById("properties-table");
  const tbody = table ? table.querySelector("tbody") : null;

  const summary = document.getElementById("summary");

  // Helper: format infrastructure distance (show "-" when no data)
  const formatDistance = (value) => {
    // If the value is null, undefined, 0, or 'N/A', show "-"
    if (!value || value === 0 || value === "N/A") return "-";
    // Otherwise, display with "min"
    return `${value} min`;
  };

  function loadUserInfo() {
    const raw = localStorage.getItem("casanova_user_info");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse user info:", e);
      return null;
    }
  }

  function loadSelectedLoanAmount() {
    const raw = localStorage.getItem("casanova_selected_loan_amount");
    if (!raw) return 0;
    try {
      return Number(JSON.parse(raw));
    } catch (e) {
      console.error("Failed to parse selected loan amount:", e);
      return 0;
    }
  }

  function loadSelectedLoanName() {
    const raw = localStorage.getItem("casanova_selected_loan_name");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      return null;
    }
  }

  async function fetchProperties() {
    const userInfo = loadUserInfo();
    const selectedLoanAmount = loadSelectedLoanAmount();
    const container = document.getElementById("properties-card-container");

    if (!userInfo) {
      statusBox.textContent =
        "No user information found. Please go back to the first page and enter your details again.";
      return;
    }

    const loanName = loadSelectedLoanName();
    const hasLoan = selectedLoanAmount > 0;

    let summaryHtml = "";
    if (hasLoan) {
      summaryHtml += `<p>Selected loan product: <strong>${
        loanName || "Selected"
      }</strong></p>`;
      summaryHtml += `<p>Loan limit: <strong>${selectedLoanAmount.toLocaleString(
        "en-US"
      )} KRW</strong></p>`;
    } else {
      summaryHtml += `<p>Property recommendations are based on your own assets (no loan selected).</p>`;
    }
    if (summary) summary.innerHTML = summaryHtml;

    statusBox.textContent = "Fetching property recommendations...";
    if (container) container.style.display = "none";
    if (table) table.style.display = "none";

    try {
      const res = await fetch(`${API_BASE}/recommend-properties/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_info: userInfo,
          selected_loan_amount: selectedLoanAmount,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        statusBox.textContent = `Error: ${res.status} ${res.statusText} - ${text}`;
        return;
      }

      const data = await res.json();

      if (data.message && data.message !== "success") {
        statusBox.textContent = data.message;
      } else {
        statusBox.textContent = "Here are your recommended properties.";
      }

      const properties = data.properties || [];

      if (!properties.length) {
        // Result-not-found card
        const loanStatusMessage =
          selectedLoanAmount === 0
            ? "With your current assets only, no suitable listings were found in the selected area."
            : "With the selected loan limit, no properties matched your criteria.";

        const htmlContent = `
            <div class="result-not-found-card">
                <h2>No property recommendations üò¢</h2>
                <p>${loanStatusMessage}</p>
                <p>
                    Try adjusting your budget ceiling, preferred district, or infrastructure priorities.
                </p>
                <div class="action-buttons">
                    <a href="/info-1/" class="btn-action btn-secondary-action">
                        ‚¨ÖÔ∏è Re-enter financial information
                    </a>
                    <a href="/loans.html" class="btn-action btn-primary-action">
                        Choose a different loan limit
                    </a>
                </div>
            </div>
        `;

        if (statusBox && statusBox.parentNode) {
          statusBox.parentNode.innerHTML = htmlContent;
        } else {
          statusBox.textContent =
            "No suitable properties were found. Please adjust your budget or preferred location.";
        }

        return;
      }

      // ============================================
      // Property recommendation card rendering
      // ============================================
      if (container) container.innerHTML = "";

      properties.slice(0, 50).forEach((prop) => {
        // 1. Price formatting (10,000 KRW unit)
        const priceValue =
          typeof prop.price_10k === "number" ? prop.price_10k : 0;
        const priceFormatted =
          priceValue.toLocaleString("en-US") + " √ó 10,000 KRW";

        // 2. Infrastructure score formatting
        const scoreValue =
          typeof prop["Infrastructure Score"] === "number"
            ? prop["Infrastructure Score"]
            : 0;
        const scoreFormatted = scoreValue.toFixed(1);

        // 3. Infrastructure distance values (using helper)
        const school_d = formatDistance(prop.school_distance_min);
        const mart_d = formatDistance(prop.mart_distance_min);
        const transport_d = formatDistance(prop.transport_distance_min);
        const park_d = formatDistance(prop.park_distance_min);

        const cardHTML = document.createElement("div");
        cardHTML.className = "property-item-card";
        cardHTML.innerHTML = `
            <h3>${prop.building_name || "No building name"}</h3>
            <div class="property-address">${
              prop.address || "No address information"
            }</div>

            <div class="property-price-score">
                <span class="price-value">${priceFormatted}</span>
                <div>
                    <strong>Infrastructure score</strong>
                    <span class="score-value">${scoreFormatted}</span>
                </div>
            </div>

            <div class="infra-details">
                <div>üè´ School: ${school_d}</div>
                <div>üõí Mart: ${mart_d}</div>
                <div>üöá Public transport: ${transport_d}</div>
                <div>üå≥ Park: ${park_d}</div>
            </div>
        `;

        if (container) container.appendChild(cardHTML);
      });

      statusBox.textContent = `Found ${properties.length} recommended properties.`;
      if (container) container.style.display = "grid";
      if (table) table.style.display = "none";
    } catch (err) {
      console.error(err);
      statusBox.textContent =
        "An error occurred while fetching recommendations. Please check the console for details.";
    }
  }

  fetchProperties();
</script>
