<h1>대출 상품 추천</h1>

<p>
  입력한 정보로 Django API(<code>/api/recommend-loans/</code>)에 요청하여 추천
  대출 상품을 조회합니다.
</p>

<p>
  <a href="/index.html">← 처음으로 돌아가기</a>
</p>

<div id="status-box" style="margin-top: 1rem">요청 준비 중...</div>

<table
  id="loans-table"
  border="1"
  cellpadding="6"
  cellspacing="0"
  style="margin-top: 1rem; display: none"
>
  <thead>
    <tr>
      <th>상품명</th>
      <th>점수</th>
      <th>최대 대출액 (원)</th>
      <th>선택</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const API_BASE = "http://127.0.0.1:8000/api";
  const statusBox = document.getElementById("status-box");
  const table = document.getElementById("loans-table");
  const tbody = table.querySelector("tbody");

  function loadUserInfo() {
    const raw = localStorage.getItem("casanova_user_info");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse user info:", e);
      return null;
    }
  }

  async function fetchLoanRecommendations() {
    const userInfo = loadUserInfo();
    if (!userInfo) {
      statusBox.textContent =
        "사용자 정보가 없습니다. 처음 페이지에서 다시 입력해주세요.";
      return;
    }

    statusBox.textContent = "대출 상품 추천을 불러오는 중입니다...";

    try {
      const res = await fetch(`${API_BASE}/recommend-loans/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_info: userInfo }),
      });

      if (!res.ok) {
        const text = await res.text();
        statusBox.textContent = `오류 발생: ${res.status} ${res.statusText} - ${text}`;
        return;
      }

      const data = await res.json();
      const loans = data.loan_recommendations || [];

      if (!loans.length) {
        statusBox.textContent =
          "조건에 맞는 대출 상품이 없습니다. 입력값을 조정해보세요.";
        return;
      }

      // 표 렌더링
      tbody.innerHTML = "";
      loans.slice(0, 20).forEach((loan) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = loan.name;

        const tdScore = document.createElement("td");
        tdScore.textContent = loan.score.toFixed(2);

        const tdMaxLoan = document.createElement("td");
        tdMaxLoan.textContent = loan.max_loan.toLocaleString("ko-KR");

        const tdSelect = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "이 상품 선택";
        btn.addEventListener("click", () => {
          // 선택한 대출 한도 저장 후 부동산 추천 페이지로 이동
          localStorage.setItem(
            "casanova_selected_loan_amount",
            JSON.stringify(loan.max_loan)
          );
          // (선택한 상품 정보도 원하면 같이 저장 가능)
          localStorage.setItem(
            "casanova_selected_loan_name",
            JSON.stringify(loan.name)
          );
          window.location.href = "/properties.html";
        });
        tdSelect.appendChild(btn);

        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        tr.appendChild(tdMaxLoan);
        tr.appendChild(tdSelect);
        tbody.appendChild(tr);
      });

      statusBox.textContent = "대출 상품을 선택해주세요.";
      table.style.display = "table";
    } catch (err) {
      console.error(err);
      statusBox.textContent =
        "요청 중 오류가 발생했습니다. 콘솔 로그를 확인해주세요.";
    }
  }

  fetchLoanRecommendations();
</script>
