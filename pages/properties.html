---
layout: default
title: "ë¶€ë™ì‚° ì¶”ì²œ ê²°ê³¼ (Info 3)"
permalink: /properties.html  # JS ë¡œì§ì˜ ê²½ë¡œì™€ ì¼ì¹˜
---

<h1>ë¶€ë™ì‚° ì¶”ì²œ ê²°ê³¼</h1>

<p>
  ì‚¬ìš©ì ì •ë³´ì™€ ì„ íƒí•œ ëŒ€ì¶œ í•œë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Django API(<code>/api/recommend-properties/</code>)ì—ì„œ ì¶”ì²œ ë¶€ë™ì‚° ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
</p>

<div class="header-action" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
    <a href="{{ '/info-1/' | relative_url }}" style="color:var(--casa-nova-primary); text-decoration:none;">
        â† ì¬ë¬´ ì •ë³´ ë‹¤ì‹œ ì…ë ¥í•˜ê¸°
    </a>
    <a href="{{ '/loans.html' | relative_url }}" style="color:var(--casa-nova-primary); text-decoration:none;">
        ëŒ€ì¶œ ì¶”ì²œ ë‹¤ì‹œ ë³´ê¸° â†’
    </a>
</div>


<div id="status-box" style="margin-top: 1rem; font-weight: bold; font-size: 1.1em; padding: 10px; border: 1px solid var(--casa-nova-secondary); background-color: #f9f9ff; border-radius: 8px;">
    ìš”ì²­ ì¤€ë¹„ ì¤‘...
</div>

<div id="properties-card-container" class="property-card-grid" style="display: none;">
    </div>



<script>
  const API_BASE = "http://127.0.0.1:8000/api";
  const statusBox = document.getElementById("status-box");

  // ì´ì „ í…Œì´ë¸” ê´€ë ¨ ìš”ì†Œ (ì°¸ì¡°ëŠ” ìœ ì§€í•˜ë˜, ë‚˜ì¤‘ì— ìˆ¨ê¹ë‹ˆë‹¤)
  const table = document.getElementById("properties-table");
  const tbody = table ? table.querySelector("tbody") : null;

  const summary = document.getElementById("summary");

  // â­ï¸â­ï¸ ì¸í”„ë¼ ê±°ë¦¬ í¬ë§·íŒ… í—¬í¼ í•¨ìˆ˜ (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ '-' í‘œì‹œ)
  const formatDistance = (value) => {
      // ê°’ì´ null, undefined, 0, ë˜ëŠ” 'N/A'ì¸ ê²½ìš° '-' ë°˜í™˜
      if (!value || value === 0 || value === 'N/A') return '-'; 
      // ê°’ì´ ìˆì„ ê²½ìš° 'ë¶„'ì„ ë¶™ì—¬ ë°˜í™˜
      return `${value}ë¶„`; 
  };
  
  function loadUserInfo() {
    const raw = localStorage.getItem("casanova_user_info");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse user info:", e);
      return null;
    }
  }

  function loadSelectedLoanAmount() {
    const raw = localStorage.getItem("casanova_selected_loan_amount");
    if (!raw) return 0;
    try {
      return Number(JSON.parse(raw));
    } catch (e) {
      console.error("Failed to parse selected loan amount:", e);
      return 0;
    }
  }

  function loadSelectedLoanName() {
    const raw = localStorage.getItem("casanova_selected_loan_name");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      return null;
    }
  }

  async function fetchProperties() {
    const userInfo = loadUserInfo();
    const selectedLoanAmount = loadSelectedLoanAmount();
    // â­ï¸ ìƒˆ ì»¨í…Œì´ë„ˆ ì°¸ì¡°
    const container = document.getElementById("properties-card-container");

    if (!userInfo) {
      statusBox.textContent =
        "ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
      return;
    }

    const loanName = loadSelectedLoanName();
    const hasLoan = selectedLoanAmount > 0;

    let summaryHtml = "";
    if (hasLoan) {
      summaryHtml += `<p>ì„ íƒí•œ ëŒ€ì¶œ ìƒí’ˆ: <strong>${
        loanName || "ì„ íƒë¨"
      }</strong></p>`;
      summaryHtml += `<p>ëŒ€ì¶œ í•œë„: <strong>${selectedLoanAmount.toLocaleString(
        "ko-KR"
      )}ì›</strong></p>`;
    } else {
      summaryHtml += `<p>ëŒ€ì¶œ ì—†ì´ ë³´ìœ  ìì‚°ë§Œìœ¼ë¡œ ë¶€ë™ì‚°ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>`;
    }
    if (summary) summary.innerHTML = summaryHtml;

    statusBox.textContent = "ë¶€ë™ì‚° ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
    if (container) container.style.display = "none";
    if (table) table.style.display = "none";


    try {
      const res = await fetch(`${API_BASE}/recommend-properties/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_info: userInfo,
          selected_loan_amount: selectedLoanAmount,
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        statusBox.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${res.status} ${res.statusText} - ${text}`;
        return;
      }

      const data = await res.json();

      if (data.message && data.message !== "success") {
        statusBox.textContent = data.message;
      } else {
        statusBox.textContent = "ì¶”ì²œ ê²°ê³¼ì…ë‹ˆë‹¤.";
      }

      const properties = data.properties || [];

      if (!properties.length) {
        // â­ï¸ ê²°ê³¼ ì—†ìŒ ì¹´ë“œ ë¡œì§ (ë§í¬ /info-1/ë¡œ ìˆ˜ì •ë¨)
        const loanStatusMessage = selectedLoanAmount === 0 
            ? "ë³´ìœ  ìì‚°ë§Œìœ¼ë¡œëŠ” í•´ë‹¹ ì§€ì—­ì— ë§ëŠ” ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤."
            : "ì„ íƒí•œ ëŒ€ì¶œ í•œë„ë¡œëŠ” ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.";

        const htmlContent = `
            <div class="result-not-found-card">
                <h2>ë§¤ë¬¼ ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢</h2>
                <p>${loanStatusMessage}</p>
                <p>
                    ì˜ˆì‚° ìƒí•œì„ , í¬ë§ ì§€ì—­ ë˜ëŠ” ì¸í”„ë¼ ê°€ì¤‘ì¹˜ë¥¼ ì¡°ì ˆí•´ ë³´ì„¸ìš”.
                </p>
                <div class="action-buttons">
                    <a href="{{ '/info-1/' | relative_url }}" class="btn-action btn-secondary-action"> 
                        â¬…ï¸ ì¬ë¬´ ì •ë³´ ë‹¤ì‹œ ì…ë ¥í•˜ê¸°
                    </a>
                    <a href="{{ '/loans.html' | relative_url }}" class="btn-action btn-primary-action">
                        ëŒ€ì¶œ í•œë„ ë‹¤ì‹œ ì„ íƒí•˜ê¸°
                    </a>
                </div>
            </div>
        `;

        if (statusBox && statusBox.parentNode) {
            statusBox.parentNode.innerHTML = htmlContent;
        } else {
            statusBox.textContent = "No suitable properties were found. Please adjust your budget or location.";
        }
        
        return;
      }

      // â­ï¸â­ï¸â­ï¸ ë¶€ë™ì‚° ì¶”ì²œ ì¹´ë“œ ë Œë”ë§ ë¡œì§ (ìµœì¢… ë²„ì „) â­ï¸â­ï¸â­ï¸
      if (container) container.innerHTML = "";
      
      properties.slice(0, 50).forEach((prop) => {
        
        // 1. ê°€ê²© í¬ë§·íŒ… (ë§Œì› ë‹¨ìœ„)
        const priceValue = typeof prop.price_10k === "number" ? prop.price_10k : 0; 
        const priceFormatted = priceValue.toLocaleString("ko-KR") + 'ë§Œì›';
        
        // 2. ì ìˆ˜ í¬ë§·íŒ…
        const scoreValue = typeof prop["Infrastructure Score"] === "number" ? prop["Infrastructure Score"] : 0;
        const scoreFormatted = scoreValue.toFixed(1);
        
        // 3. ì¸í”„ë¼ ê±°ë¦¬ ë°ì´í„° (formatDistance í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)
        const school_d = formatDistance(prop.school_distance_min);
        const mart_d = formatDistance(prop.mart_distance_min);
        const transport_d = formatDistance(prop.transport_distance_min);
        const park_d = formatDistance(prop.park_distance_min);
        
        const cardHTML = document.createElement('div');
        cardHTML.className = 'property-item-card';
        cardHTML.innerHTML = `
            <h3>${prop.building_name || 'ê±´ë¬¼ëª… ì—†ìŒ'}</h3>
            <div class="property-address">${prop.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
            
            <div class="property-price-score">
                <span class="price-value">${priceFormatted}</span>
                <div>
                    <strong>ì¸í”„ë¼ ì ìˆ˜</strong>
                    <span class="score-value">${scoreFormatted}</span>
                </div>
            </div>
            
            <div class="infra-details">
                <div>ğŸ« í•™êµ ê±°ë¦¬: ${school_d}</div>
                <div>ğŸ›’ ë§ˆíŠ¸ ê±°ë¦¬: ${mart_d}</div>
                <div>ğŸš‡ êµí†µ ê±°ë¦¬: ${transport_d}</div>
                <div>ğŸŒ³ ê³µì› ê±°ë¦¬: ${park_d}</div>
            </div>
        `;
        
        if (container) container.appendChild(cardHTML);
      });
      
      statusBox.textContent = `ì¶”ì²œ ë§¤ë¬¼ ${properties.length}ê±´ì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤.`;
      if (container) container.style.display = "grid"; 
      if (table) table.style.display = "none"; 

    } catch (err) {
      console.error(err);
      statusBox.textContent =
        "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
    }
  }

  fetchProperties();
</script>
