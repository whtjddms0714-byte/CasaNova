---
layout: default
title: "Loan Recommendations (Info 2)"
permalink: /loans.html  # Must match JS redirects
---

<h1>Loan Recommendations</h1>

<p>
  Based on your input, this page requests recommended loan products from the Django API
  (<code>/api/recommend-loans/</code>).
</p>

<div class="header-action" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
    <span id="status-box" style="font-weight: bold; font-size: 1.1em;">Preparing request...</span>
    <a href="/info-1/" style="color:var(--casa-nova-primary); text-decoration:none;">
        ‚Üê Re-enter financial information
    </a>
</div>

<div id="loans-card-container" class="loan-card-grid" style="display: none;"></div>

<script>
  const API_BASE = "http://127.0.0.1:8000/api";
  const statusBox = document.getElementById("status-box");

  // English loan name word-list
  const PRODUCT_NAMES = [
    "Prime", "Apex", "Elite", "Vision", "Trust", "Global", "Secure", "Capital",
    "Future", "Harmony", "Unity", "Clarity", "Ascent", "Liberty", "Venture", "Keystone"
  ];

  function loadUserInfo() {
    const raw = localStorage.getItem("casanova_user_info");
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to parse user info:", e);
      return null;
    }
  }

  async function fetchLoanRecommendations() {
    const userInfo = loadUserInfo();
    const container = document.getElementById("loans-card-container");
    const PROPERTY_URL = "{{ '/properties.html' | relative_url }}";
    if (!userInfo) {
      statusBox.textContent =
        "No user information found. Please return to the Find Home page and enter your information.";
      return;
    }

    statusBox.textContent = "Fetching loan recommendations...";

    try {
      const res = await fetch(`${API_BASE}/recommend-loans/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_info: userInfo }),
      });

      if (!res.ok) {
        const text = await res.text();
        statusBox.textContent = `Error: ${res.status} ${res.statusText} - ${text}`;
        return;
      }

      const data = await res.json();
      const loans = data.loan_recommendations || [];

      if (!loans.length) {
        // No results card
        const htmlContent = `
            <div class="result-not-found-card">
                <h2>No Loan Recommendations üò•</h2>
                <p>
                    Based on your financial information, no suitable loan products were found.
                </p>
                <div class="action-buttons">
                    <a href="/info-1/" class="btn-action btn-primary-action">
                        Re-enter financial information ‚Üí
                    </a>
                </div>
            </div>
        `;
        const parentContainer = container.parentNode;
        parentContainer.innerHTML = htmlContent;
        return;
      }

      // Render loan cards
      container.innerHTML = "";

      loans.slice(0, 20).forEach((loan, index) => {
        const wordIndex = index % PRODUCT_NAMES.length;
        const loanWord = PRODUCT_NAMES[wordIndex];
        const newLoanName = `${loanWord} Loan`;

        const maxLoanFormatted =
          loan.max_loan.toLocaleString("en-US") + " KRW";
        const scoreFormatted = loan.score.toFixed(2);

        const cardHTML = document.createElement("div");
        cardHTML.className = "loan-item-card";
        cardHTML.innerHTML = `
            <h3>${newLoanName}</h3>
            <div class="loan-details">
                <div class="detail-box">
                    <strong>Recommendation Score</strong>
                    <span class="detail-value-score">${scoreFormatted}</span>
                </div>
                <div class="detail-box">
                    <strong>Maximum Loan Amount</strong>
                    <span class="detail-value-amount">${maxLoanFormatted}</span>
                </div>
            </div>
            <button 
                class="btn-select-loan" 
                data-max-loan="${loan.max_loan}" 
                data-loan-name="${loan.name}">
                Select this Loan ‚Üí
            </button>
        `;

        container.appendChild(cardHTML);
      });

      statusBox.textContent = "Please choose a loan product.";
      container.style.display = "grid";

      // Add click listener for each loan button
      container.querySelectorAll(".btn-select-loan").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const maxLoan = Number(e.currentTarget.dataset.maxLoan);
          const loanName = e.currentTarget.dataset.loanName;

          localStorage.setItem(
            "casanova_selected_loan_amount",
            JSON.stringify(maxLoan)
          );
          localStorage.setItem(
            "casanova_selected_loan_name",
            JSON.stringify(loanName)
          );

          window.location.href = PROPERTY_URL;
        });
      });

    } catch (err) {
      console.error(err);
      statusBox.textContent =
        "An error occurred while requesting loan recommendations. Check console logs for details.";
    }
  }

  fetchLoanRecommendations();
</script>
