<script>
  const form = document.getElementById("user-form");
  const errorBox = document.getElementById("error-message");
  const priorityList = document.getElementById("priority-list");
  const skipLoanButton = document.getElementById("skip-loan");

  // ✅ 실제 파일 위치에 맞춘 경로 (pages/loans.html, pages/properties.html)
  const LOAN_URL = "{{ '/pages/loans.html' | relative_url }}";
  const PROPERTY_URL = "{{ '/pages/properties.html' | relative_url }}";

  // ----------------------------------------------------
  // 드래그 앤 드롭 로직 (간단 구현)
  // ----------------------------------------------------
  let draggingItem = null;

  priorityList.addEventListener("dragstart", (e) => {
    if (e.target.classList.contains("priority-item")) {
      draggingItem = e.target;
      setTimeout(() => e.target.classList.add("dragging"), 0);
    }
  });

  priorityList.addEventListener("dragend", (e) => {
    e.target.classList.remove("dragging");
    draggingItem = null;
    // 드래그가 끝났을 때 순위 번호 업데이트
    updatePriorityRanks();
  });

  priorityList.addEventListener(
    "dragover",
    (e) => {
      e.preventDefault();
      if (draggingItem) {
        const afterElement = getDragAfterElement(priorityList, e.clientY);
        const currentItem = draggingItem;
        if (afterElement == null) {
          priorityList.appendChild(currentItem);
        } else {
          priorityList.insertBefore(currentItem, afterElement);
        }
      }
    },
    false
  );

  function getDragAfterElement(container, y) {
    const draggableElements = [
      ...container.querySelectorAll(".priority-item:not(.dragging)"),
    ];

    return draggableElements.reduce(
      (closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      },
      { offset: Number.NEGATIVE_INFINITY }
    ).element;
  }

  // 순위 번호를 업데이트하는 함수
  function updatePriorityRanks() {
    const items = priorityList.querySelectorAll(".priority-item");
    items.forEach((item, index) => {
      item.querySelector(".priority-rank").textContent = `[${index + 1}]`;
    });
  }

  // ----------------------------------------------------
  // 가중치 계산 로직
  // ----------------------------------------------------
  function getPriorityWeights() {
    const listItems = document.querySelectorAll(
      "#priority-list .priority-item"
    );

    // 백엔드에서 요구하는 순서: w_park, w_school, w_mart, w_transport
    const weightsMap = {
      w_park: 0,
      w_school: 1,
      w_mart: 2,
      w_transport: 3,
    };

    // [w_park, w_school, w_mart, w_transport] 순서로 저장될 배열 (초기값 0)
    const orderedWeights = [0, 0, 0, 0];

    // 순위대로 4, 3, 2, 1 가중치 부여
    listItems.forEach((item, index) => {
      const weightValue = 4 - index; // 1위: 4, 4위: 1
      const key = item.getAttribute("data-key"); // data-key (w_park, w_school 등) 읽기

      // 올바른 순서대로 가중치를 배열에 삽입
      if (weightsMap.hasOwnProperty(key)) {
        orderedWeights[weightsMap[key]] = weightValue;
      }
    });

    return orderedWeights;
  }

  // ----------------------------------------------------
  // 공통: 폼 데이터에서 userInfo 객체 만드는 함수
  // ----------------------------------------------------
  function buildUserInfo() {
    errorBox.textContent = "";

    const income_monthly = Number(
      document.getElementById("income_monthly").value || 0
    );
    const credit_score = Number(
      document.getElementById("credit_score").value || 0
    );
    const dsr_ratio = Number(document.getElementById("dsr_ratio").value || 0.4);
    const existing_debt = Number(
      document.getElementById("existing_debt").value || 0
    );
    const existing_debt_monthly_payment = Number(
      document.getElementById("existing_debt_monthly_payment").value || 0
    );
    const married = document.getElementById("married").checked;
    const first_job = document.getElementById("first_job").checked;

    const asset = Number(document.getElementById("asset").value || 0);
    const budget_limit_raw = document.getElementById("budget_limit").value;
    const budget_limit = budget_limit_raw ? Number(budget_limit_raw) : null;
    const target_gu = document.getElementById("target_gu").value || "";

    // 드래그 순서에 따른 가중치
    const weights = getPriorityWeights();

    if (!income_monthly || !credit_score) {
      errorBox.textContent = "월 소득과 신용점수는 필수입니다.";
      return null;
    }

    return {
      income_monthly,
      credit_score,
      dsr_ratio,
      existing_debt,
      existing_debt_monthly_payment,
      married,
      first_job,
      asset,
      budget_limit,
      target_gu,
      weights,
    };
  }

  // ----------------------------------------------------
  // 폼 제출 이벤트 (대출 추천 받고 진행하기)
  // ----------------------------------------------------
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const userInfo = buildUserInfo();
    if (!userInfo) return;

    // localStorage에 저장
    localStorage.setItem("casanova_user_info", JSON.stringify(userInfo));

    // ✅ 대출 추천 페이지로 이동 (pages/loans.html)
    window.location.href = LOAN_URL;
  });

  // ----------------------------------------------------
  // 대출 없이 바로 매물 찾기 버튼 로직
  // ----------------------------------------------------
  skipLoanButton.addEventListener("click", () => {
    const userInfo = buildUserInfo();
    if (!userInfo) return;

    // 유저 정보 저장
    localStorage.setItem("casanova_user_info", JSON.stringify(userInfo));
    // 대출 금액 0으로 설정
    localStorage.setItem(
      "casanova_selected_loan_amount",
      JSON.stringify(0)
    );

    // ✅ 바로 부동산 추천 페이지로 이동 (pages/properties.html)
    window.location.href = PROPERTY_URL;
  });
</script>
