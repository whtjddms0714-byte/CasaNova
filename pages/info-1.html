---
layout: default
title: "Find Home - Info 1"
permalink: /info-1/  # Make sure this matches your JS redirects
---

<h1>CasaNova Simulator</h1>
<p>Please enter your information below to move to the next step.</p>

<form id="user-form">
  <div class="input-grid">
    <div class="input-card">
      <h2>1. Financial Information</h2>

      <label>
        Monthly income (KRW)
        <input
          type="number"
          id="income_monthly"
          required
          placeholder="e.g. 4000000"
        />
      </label>
      <label>
        Credit score
        <input type="number" id="credit_score" required placeholder="e.g. 750" />
      </label>
      <label>
        DSR ratio (0‚Äì1, e.g. 0.4)
        <input type="number" step="0.01" id="dsr_ratio" value="0.4" required />
      </label>
      <label>
        Existing debt principal (KRW)
        <input type="number" id="existing_debt" value="0" />
      </label>
      <label>
        Existing monthly repayment (KRW)
        <input type="number" id="existing_debt_monthly_payment" value="0" />
      </label>
      <label style="display: block; margin-bottom: 15px">
        <input
          type="checkbox"
          id="married"
          style="width: auto; margin-right: 5px"
        />
        Married
      </label>
      <label style="display: block">
        <input
          type="checkbox"
          id="first_job"
          style="width: auto; margin-right: 5px"
        />
        First full-time job / early career
      </label>
    </div>

    <div class="input-card">
      <h2>2. Housing Preferences</h2>

      <label>
        Total assets (KRW)
        <input type="number" id="asset" value="0" required />
      </label>
      <label>
        Budget ceiling (in 10,000 KRW, optional)
        <input type="number" id="budget_limit" placeholder="e.g. 60000 (600M KRW)" />
      </label>
      <label>
        Preferred district (e.g. Gangnam-gu)
        <input type="text" id="target_gu" placeholder="e.g. Gangnam-gu" />
      </label>
    </div>

    <div class="input-card">
      <h2>3. Infrastructure Priority</h2>
      <p style="font-size: 0.9em; color: #555">
        Drag and drop the items to set your priority order.
      </p>

      <ul id="priority-list" style="list-style: none; padding: 0">
        <li class="priority-item" data-key="w_transport" draggable="true">
          <span
            class="priority-rank"
            style="font-weight: bold; color: var(--casa-nova-primary)"
            >[1]</span
          >
          üöá Public transport (stations)
        </li>
        <li class="priority-item" data-key="w_school" draggable="true">
          <span
            class="priority-rank"
            style="font-weight: bold; color: var(--casa-nova-primary)"
            >[2]</span
          >
          üè´ Schools
        </li>
        <li class="priority-item" data-key="w_mart" draggable="true">
          <span
            class="priority-rank"
            style="font-weight: bold; color: var(--casa-nova-primary)"
            >[3]</span
          >
          üõí Marts / supermarkets
        </li>
        <li class="priority-item" data-key="w_park" draggable="true">
          <span
            class="priority-rank"
            style="font-weight: bold; color: var(--casa-nova-primary)"
            >[4]</span
          >
          üå≥ Parks
        </li>
      </ul>

      <p style="margin-top: 20px; font-size: 0.8em; color: #888">
        * 1st priority gets weight 4, 4th priority gets weight 1.
      </p>
    </div>
  </div>
  <p
    id="error-message"
    style="color: red; margin-top: 20px; text-align: center"
  ></p>

  <div class="button-group">
    <button type="submit" class="btn-primary">Get loan recommendations ‚Üí</button>
    <button type="button" id="skip-loan" class="btn-secondary">
      Skip loans and find properties ‚Üí 
    </button>
  </div>
</form>

<script>
  const form = document.getElementById("user-form");
  const errorBox = document.getElementById("error-message");
  const priorityList = document.getElementById("priority-list");
  const skipLoanButton = document.getElementById("skip-loan");

  // ----------------------------------------------------
  // Drag & drop logic (simple implementation)
  // ----------------------------------------------------
  let draggingItem = null;

  priorityList.addEventListener("dragstart", (e) => {
    if (e.target.classList.contains("priority-item")) {
      draggingItem = e.target;
      setTimeout(() => e.target.classList.add("dragging"), 0);
    }
  });

  priorityList.addEventListener("dragend", (e) => {
    e.target.classList.remove("dragging");
    draggingItem = null;
    // Update rank numbers after drag ends
    updatePriorityRanks();
  });

  priorityList.addEventListener(
    "dragover",
    (e) => {
      e.preventDefault();
      if (draggingItem) {
        const afterElement = getDragAfterElement(priorityList, e.clientY);
        const currentItem = draggingItem;
        if (afterElement == null) {
          priorityList.appendChild(currentItem);
        } else {
          priorityList.insertBefore(currentItem, afterElement);
        }
      }
    },
    false
  );

  function getDragAfterElement(container, y) {
    const draggableElements = [
      ...container.querySelectorAll(".priority-item:not(.dragging)"),
    ];

    return draggableElements.reduce(
      (closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      },
      { offset: Number.NEGATIVE_INFINITY }
    ).element;
  }

  // Update the displayed rank numbers
  function updatePriorityRanks() {
    const items = priorityList.querySelectorAll(".priority-item");
    items.forEach((item, index) => {
      item.querySelector(".priority-rank").textContent = `[${index + 1}]`;
    });
  }

  // ----------------------------------------------------
  // Priority weight calculation
  // ----------------------------------------------------
  function getPriorityWeights() {
    const listItems = document.querySelectorAll(
      "#priority-list .priority-item"
    );

    // Backend expects order: w_park, w_school, w_mart, w_transport
    const weightsMap = {
      w_park: 0,
      w_school: 1,
      w_mart: 2,
      w_transport: 3,
    };

    // Array in order [w_park, w_school, w_mart, w_transport]
    const orderedWeights = [0, 0, 0, 0];

    // Assign weights 4, 3, 2, 1 by rank
    listItems.forEach((item, index) => {
      const weightValue = 4 - index; // 1st: 4, 4th: 1
      const key = item.getAttribute("data-key");

      if (weightsMap.hasOwnProperty(key)) {
        orderedWeights[weightsMap[key]] = weightValue;
      }
    });

    return orderedWeights;
  }

  // ----------------------------------------------------
  // Common: build userInfo object from form data
  // ----------------------------------------------------
  function buildUserInfo() {
    errorBox.textContent = "";

    const income_monthly = Number(
      document.getElementById("income_monthly").value || 0
    );
    const credit_score = Number(
      document.getElementById("credit_score").value || 0
    );
    const dsr_ratio = Number(document.getElementById("dsr_ratio").value || 0.4);
    const existing_debt = Number(
      document.getElementById("existing_debt").value || 0
    );
    const existing_debt_monthly_payment = Number(
      document.getElementById("existing_debt_monthly_payment").value || 0
    );
    const married = document.getElementById("married").checked;
    const first_job = document.getElementById("first_job").checked;

    const asset = Number(document.getElementById("asset").value || 0);
    const budget_limit_raw = document.getElementById("budget_limit").value;
    const budget_limit = budget_limit_raw ? Number(budget_limit_raw) : null;
    const target_gu = document.getElementById("target_gu").value || "";

    const weights = getPriorityWeights();

    if (!income_monthly || !credit_score) {
      errorBox.textContent =
        "Monthly income and credit score are required fields.";
      return null;
    }

    return {
      income_monthly,
      credit_score,
      dsr_ratio,
      existing_debt,
      existing_debt_monthly_payment,
      married,
      first_job,
      asset,
      budget_limit,
      target_gu,
      weights,
    };
  }

  // ----------------------------------------------------
  // Submit event: ‚ÄúGet loan recommendations‚Äù
  // ----------------------------------------------------
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const userInfo = buildUserInfo();
    if (!userInfo) return;

    localStorage.setItem("casanova_user_info", JSON.stringify(userInfo));

    window.location.href = "/loans.html";
  });

  // ----------------------------------------------------
  // ‚ÄúSkip loans and go directly to properties‚Äù button
  // ----------------------------------------------------
  skipLoanButton.addEventListener("click", () => {
    const userInfo = buildUserInfo();
    if (!userInfo) return;

    localStorage.setItem("casanova_user_info", JSON.stringify(userInfo));
    localStorage.setItem(
      "casanova_selected_loan_amount",
      JSON.stringify(0)
    );

    window.location.href = "/properties.html";
  });
</script>
