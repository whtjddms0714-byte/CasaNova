<script>
  const form = document.getElementById("user-form");
  const errorBox = document.getElementById("error-message");
  const priorityList = document.getElementById("priority-list");
  const skipLoanButton = document.getElementById("skip-loan");

  // ✅ Jekyll permalink 기준 경로
  const LOAN_URL = "{{ '/loans.html' | relative_url }}";
  const PROPERTY_URL = "{{ '/properties.html' | relative_url }}";

  // ----------------------------------------------------
  // 드래그 앤 드롭 로직 (간단 구현)
  // ----------------------------------------------------
  let draggingItem = null;

  priorityList.addEventListener("dragstart", (e) => {
    if (e.target.classList.contains("priority-item")) {
      draggingItem = e.target;
      setTimeout(() => e.target.classList.add("dragging"), 0);
    }
  });

  priorityList.addEventListener("dragend", (e) => {
    e.target.classList.remove("dragging");
    draggingItem = null;
    updatePriorityRanks();
  });

  priorityList.addEventListener(
    "dragover",
    (e) => {
      e.preventDefault();
      if (draggingItem) {
        const afterElement = getDragAfterElement(priorityList, e.clientY);
        const currentItem = draggingItem;
        if (afterElement == null) {
          priorityList.appendChild(currentItem);
        } else {
          priorityList.insertBefore(currentItem, afterElement);
        }
      }
    },
    false
  );

  function getDragAfterElement(container, y) {
    const draggableElements = [
      ...container.querySelectorAll(".priority-item:not(.dragging)"),
    ];

    return draggableElements.reduce(
      (closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      },
      { offset: Number.NEGATIVE_INFINITY }
    ).element;
  }

  function updatePriorityRanks() {
    const items = priorityList.querySelectorAll(".priority-item");
    items.forEach((item, index) => {
      item.querySelector(".priority-rank").textContent = `[${index + 1}]`;
    });
  }

  function getPriorityWeights() {
    const listItems = document.querySelectorAll(
      "#priority-list .priority-item"
    );

    const weightsMap = {
      w_park: 0,
      w_school: 1,
      w_mart: 2,
      w_transport: 3,
    };

    const orderedWeights = [0, 0, 0, 0];

    listItems.forEach((item, index) => {
      const weightValue = 4 - index;
      const key = item.getAttribute("data-key");

      if (weightsMap.hasOwnProperty(key)) {
        orderedWeights[weightsMap[key]] = weightValue;
      }
    });

    return orderedWeights;
  }

  function buildUserInfo() {
    errorBox.textContent = "";

    const income_monthly = Number(
      document.getElementById("income_monthly").value || 0
    );
    const credit_score = Number(
      document.getElementById("credit_score").value || 0
    );
    const dsr_ratio = Number(document.getElementById("dsr_ratio").value || 0.4);
    const existing_debt = Number(
      document.getElementById("existing_debt").value || 0
    );
    const existing_debt_monthly_payment = Number(
      document.getElementById("existing_debt_monthly_payment").value || 0
    );
    const married = document.getElementById("married").checked;
    const first_job = document.getElementById("first_job").checked;

    const asset = Number(document.getElementById("asset").value || 0);
    const budget_limit_raw = document.getElementById("budget_limit").value;
    const budget_limit = budget_limit_raw ? Number(budget_limit_raw) : null;
    const target_gu = document.getElementById("target_gu").value || "";

    const weights = getPriorityWeights();

    if (!income_monthly || !credit_score) {
      errorBox.textContent = "월 소득과 신용점수는 필수입니다.";
      return null;
    }

    return {
      income_monthly,
      credit_score,
      dsr_ratio,
      existing_debt,
      existing_debt_monthly_payment,
      married,
      first_job,
      asset,
      budget_limit,
      target_gu,
      weights,
    };
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const userInfo = buildUserInfo();
    if (!userInfo) return;

    localStorage.setItem("casanova_user_info", JSON.stringify(userInfo));

    // ✅ 대출 추천 페이지로 이동
    // 디버깅용: 실제 LOAN_URL 확인
    console.log("LOAN_URL =", LOAN_URL);
    window.location.href = LOAN_URL;
  });

  skipLoanButton.addEventListener("click", () => {
    const userInfo = buildUserInfo();
    if (!userInfo) return;

    localStorage.setItem("casanova_user_info", JSON.stringify(userInfo));
    localStorage.setItem(
      "casanova_selected_loan_amount",
      JSON.stringify(0)
    );

    console.log("PROPERTY_URL =", PROPERTY_URL);
    window.location.href = PROPERTY_URL;
  });
</script>
